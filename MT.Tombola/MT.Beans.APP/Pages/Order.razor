@page "/order"
@page "/order/{ExternalId}"
@using MT.Beans.App.Service.BeansApiClient
@using System.ComponentModel.DataAnnotations
@inject IBeansApiClientService<BeanDto> BeansApiClientService

<h3>Order Beans</h3>

<EditForm Model="order" OnValidSubmit="Submit">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <!-- Bean selection -->
    <div class="mb-3">
        <label class="form-label">Bean</label>
        <InputSelect class="form-select"
                     @bind-Value="order.BeanExternalId"
                     @onchange="OnBeanChanged">
            <option value="">-- Select a bean --</option>
            @if (beans != null)
            {
                @foreach (var b in beans)
                {
                    <option value="@b.ExternalId">@b.Name (@b.Country)</option>
                }
            }
        </InputSelect>
    </div>

    <!-- Quantity -->
    <div class="mb-3">
        <label class="form-label">Quantity (bags)</label>
        <InputNumber class="form-control"
                     @bind-Value="order.Quantity"
                     @oninput="OnQuantityChanged" />
    </div>

    <!-- Email -->
    <div class="mb-3">
        <label class="form-label">Customer email</label>
        <InputText class="form-control" @bind-Value="order.Email" />
    </div>

    <!-- Total Price -->
    <div class="mb-3">
        <label class="form-label fw-bold">Total Price</label>
        <div class="form-control bg-light">
            @totalPrice.ToString("C", System.Globalization.CultureInfo.GetCultureInfo("en-GB"))
        </div>
    </div>

    <button class="btn btn-success" type="submit">Place order</button>
</EditForm>

@if (submitted)
{
    <div class="alert alert-success mt-3">
        Order placed (mock). In a real app this would call an API.
    </div>
}

@code {
    [Parameter] public string? ExternalId { get; set; }

    private List<BeanDto>? beans;
    private OrderModel order = new();
    private bool submitted;
    private decimal totalPrice;

    protected override async Task OnInitializedAsync()
    {
        beans = await BeansApiClientService.GetBeansAsync();

        if (!string.IsNullOrWhiteSpace(ExternalId))
            order.BeanExternalId = ExternalId;

        RecalculateTotal();
    }

    private void Submit()
    {
        submitted = true;
    }

    private void OnBeanChanged(ChangeEventArgs e)
    {
        order.BeanExternalId = e.Value?.ToString();
        RecalculateTotal();
    }

    private void OnQuantityChanged(ChangeEventArgs e)
    {
        if (int.TryParse(e.Value?.ToString(), out var qty))
            order.Quantity = qty;

        RecalculateTotal();
    }

    private void RecalculateTotal()
    {
        if (beans == null || string.IsNullOrWhiteSpace(order.BeanExternalId))
        {
            totalPrice = 0;
            return;
        }

        var selected = beans.FirstOrDefault(b => b.ExternalId == order.BeanExternalId);
        if (selected != null)
            totalPrice = selected.Cost * order.Quantity;
        else
            totalPrice = 0;
    }

    public class OrderModel
    {
        [Required] public string? BeanExternalId { get; set; }
        [Range(1, 100)] public int Quantity { get; set; } = 1;
        [Required, EmailAddress] public string? Email { get; set; }
    }
}
